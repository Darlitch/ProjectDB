<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>
    <title>Settings - Project DB</title>
</head>

<body>
    <div layout:fragment="content">
        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Settings</h1>
        </div>

        <div class="row">
            <!-- Change Login Card -->
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Change Login</h6>
                    </div>
                    <div class="card-body">
                        <form id="changeLoginForm">
                            <div class="form-group">
                                <label for="newLogin">New Login</label>
                                <input type="text" class="form-control" id="newLogin" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                Update Login
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Change Password Card -->
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Change Password</h6>
                    </div>
                    <div class="card-body">
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label for="oldPassword">Current Password</label>
                                <input type="password" class="form-control" id="oldPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" class="form-control" id="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                Change Password
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden logout form -->
        <form id="logoutForm" th:action="@{/logout}" method="post" style="display: none;"></form>
    </div>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            $(document).ready(function() {
                // Handle login change
                $('#changeLoginForm').submit(function(e) {
                    e.preventDefault();
                    
                    const newLogin = $('#newLogin').val();
                    
                    $.ajax({
                        url: '/api/v1/auth',
                        type: 'PATCH',
                        contentType: 'application/json',
                        headers: {
                            'Authorization': 'Bearer ' + sessionStorage.getItem('jwtToken')
                        },
                        data: JSON.stringify({
                            login: newLogin
                        }),
                        success: function(response) {
                            alert('Login updated successfully. You will be logged out.');
                            $('#logoutForm').submit();
                        },
                        error: function(xhr) {
                            alert('Error updating login: ' + (xhr.responseJSON?.message || xhr.statusText));
                        }
                    });
                });

                // Handle password change
                $('#changePasswordForm').submit(function(e) {
                    e.preventDefault();
                    
                    const oldPassword = $('#oldPassword').val();
                    const newPassword = $('#newPassword').val();
                    const confirmPassword = $('#confirmPassword').val();

                    if (newPassword !== confirmPassword) {
                        alert('New passwords do not match!');
                        return;
                    }
                    
                    $.ajax({
                        url: '/api/v1/auth/change-password',
                        type: 'PATCH',
                        contentType: 'application/json',
                        headers: {
                            'Authorization': 'Bearer ' + sessionStorage.getItem('jwtToken')
                        },
                        data: JSON.stringify({
                            oldPassword: oldPassword,
                            newPassword: newPassword,
                            confirmPassword: confirmPassword
                        }),
                        success: function() {
                            alert('Password changed successfully. You will be logged out.');
                            $('#logoutForm').submit();
                        },
                        error: function(xhr) {
                            alert('Error changing password: ' + (xhr.responseJSON?.message || xhr.statusText));
                        }
                    });
                });
            });
        </script>
    </th:block>
</body>
</html> 